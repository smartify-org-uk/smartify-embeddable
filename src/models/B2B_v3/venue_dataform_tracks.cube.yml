cubes:
- name: venue_dataform_tracks
  data_source: default
  sql: >
    select
      event_date
      ,event_params_custom.event_custom_timestamp
      ,case 
        when is_measurement_protocol_hit = true then timestamp_seconds(event_params_custom.event_custom_timestamp) 
        else timestamp_micros(time.event_timestamp)
      end as event_timestamp
      ,user_pseudo_id
      ,event_name
      ,stream_id
      ,device.category as device_category
      ,geo.country
      ,event_params_custom.client_connectivity
      ,event_params_custom.component_type
      ,event_params_custom.content_category
      ,event_params_custom.page_type
      ,case
        when event_params_custom.tour_id in ('tour_ky7qSGsnEM7jURYhFN7t','tour_Q28QfnCHK1X3np6D0Qaz','tour_e1aHNylJHOuaYj6KlyZh','tour_Kpbx9TYFTFe9jB8Kj0FM') then 'venue_miaqa'
        when event_params_custom.tour_id in ('tour_bBaHYuaqCReuevFIcD1L','tour_rFwk4w4BU6OxCozZIT6H') then 'venue_qpa'
        else event_params_custom.venue_id
      end as venue_id
      ,event_params_custom.organisation_id
      ,safe_cast(user_properties.user_age as int64) as user_age
      ,user_properties.user_gender
      ,event_params_custom.tour_id
      ,event_params_custom.track_id
      ,event_params_custom.audio_language
      ,event_params_custom.event_label
      ,case
        when event_params_custom.track_listen_time_string = 'inf' then 0
        else CAST(event_params_custom.track_listen_time_string AS NUMERIC)
      END AS track_listen_time
      ,device.language as device_language
    from `smartify-cc94e.superform_outputs_151371783.ga4_events`
    where event_params_custom.organisation_id = '{COMPILE_CONTEXT.securityContext.organisation_id}'
      /*
      and ('{COMPILE_CONTEXT.securityContext.venue_id}' IS NULL
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = ''
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = 'undefined'
          or event_params_custom.venue_id in unnest(split('{COMPILE_CONTEXT.securityContext.venue_id}', ',')))
      */
      and (event_params_custom.organisation_id != 'org_smithsonian' or (event_params_custom.organisation_id = 'org_smithsonian' and not contains_substr(event_params_custom.venue_id, ',')))
      and event_date >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 13 MONTH)
      and event_name in ('track_pause','track_start','track_start_5s','track_quartile_25','track_quartile_50','track_pseudo_complete','track_quartile_75','track_complete','track_resume','track_forward','click_button','track_backward','numpad_recognition_hit','click_icon','page_view','screen_view')
      and (stream_id in ('1047860117','1047860114','1913717213','2817285551','10374153553') or (stream_id = '4029517643' and event_params_custom.organisation_id = 'org_ukparliament'))
      and (
        event_params_custom.track_id is not null or 
        event_params_custom.tour_id is not null
        )
      
  dimensions:
    - name: datetime
      type: time
      sql: event_timestamp

    - name: user_connectivity
      type: string
      sql: |-
        case
          when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
          when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
          else 'Cellular'
        end
      
    - name: device_platform
      type: string
      sql: |-
        case
          when stream_id = '1047860117' then 'iOS'
          when stream_id = '1047860114' then 'Android'
          when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
          when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
          else 'Webapp'
        end

    - name: country
      type: string
      sql: if(country = '', 'Unknown', country)

    - name: user_gender
      type: string
      sql: |-
        case 
          when user_gender in ('Male', 'MALE', 'Man', 'Mand', 'Masculino', '男性', 'זכר', 'Männlich', 'Mann', 'Homme', 'Hombre') then 'Male' 
          when user_gender in ('Female', 'Woman', 'Femme', 'Mujer', 'Vrouw', 'Weiblich', 'Frau', 'Feminino', '女性', 'Donna', 'Kvinde') then 'Female' 
          when user_gender in ('Unspecified', 'Non spécifié', 'Sin especificar') then 'Unspecified' 
          when user_gender in ('Other', 'Autre') then 'Other'
          else 'Unknown'
        end

    - name: user_age_range
      type: string
      sql: |-
        case
          when user_age < 18 then '- 18'
          when user_age >= 18 and user_age < 25 then '18 - 24'
          when user_age >= 25 and user_age < 35 then '25 - 34'
          when user_age >= 35 and user_age < 45 then '35 - 44'
          when user_age >= 45 and user_age < 55 then '45 - 54'
          when user_age >= 55 and user_age < 65 then '55 - 64'
          when user_age >= 65 and user_age < 71 then '65 - 70'
          when user_age >= 71 then '71+' 
          else 'Unknown'
        end

    - name: device_language
      type: string
      sql: device_language
      primaryKey: true
      shown: false

    - name: organisation_id
      type: string
      sql: organisation_id
    
    - name: venue_id
      type: string
      sql: case when (venue_id = '' or venue_id is null) then 'No linked venue' else venue_id end

    - name: tour_id
      type: string
      sql: tour_id
      primaryKey: true
      shown: true

    - name: tour_type
      type: string
      sql: |-
        case 
          when STARTS_WITH(tour_id,'ptour_') then 'Bespoke Tours' 
          when STARTS_WITH(tour_id,'tour_') then 'Venue Tours' 
          else null
        end
    
    - name: track_id
      type: string
      sql: track_id
    
    - name: track_id_locale
      type: string
      sql: concat(track_id, audio_language)
      primaryKey: true
      shown: false

    - name: track_language
      type: string
      sql: audio_language
    
    - name: event_label
      type: string
      sql: event_label
    
    - name: wayfinding_survey_label
      type: string
      sql: |-
        case 
          when 
            event_name = 'click_icon'
            and component_type = 'icon_feedback'
            and contains_substr(content_category, 'wayfinding') 
            and event_label in ('negative', 'positive')
          then event_label 
          else null
        end

  measures:
    - name: tour_views
      type: count
      sql: event_name
      filters:
        - sql: event_name in ('page_view', 'screen_view')
        - sql: contains_substr(page_type, 'tour_dp')
    
    - name: tour_users
      type: count_distinct_approx
      sql: user_pseudo_id
      filters:
        - sql: event_name in ('page_view', 'screen_view', 'track_start')
        - sql: tour_id is not null

    - name: track_plays
      title: Plays
      type: count
      sql: event_name
      filters:
        - sql: event_name in ('track_start')

    - name: track_play_users
      type: count_distinct_approx
      sql: user_pseudo_id
      filters:
        - sql: event_name in ('track_start')

    - name: track_play_per_user
      type: number
      title: 'Track Play Per User'
      sql: "COALESCE(CAST({track_plays} AS FLOAT64) / NULLIF(CAST({track_play_users} AS FLOAT64), 0.0), 0.0)"
   
    - name: track_play_5s
      title: Track Plays 5s
      type: count
      sql: event_name
      filters:
        - sql: (event_date > '2025-06-11' and event_name in ('track_start_5s') or event_date <= '2025-06-11' and event_name in ('track_start'))
      
    - name: track_pseudo_complete
      type: count
      sql: event_name
      filters:
        - sql: |-
            (
              (event_date < DATE '2025-06-04' AND event_name = 'track_complete')
              OR
              (
                event_date >= DATE '2025-06-04'
                AND (
                  stream_id IN ('1047860117','10374153553')
                  OR (stream_id = '1913717213' AND event_custom_timestamp IS NOT NULL)
                )
                AND event_name = 'track_complete'
              )
              OR
              (
                event_date >= DATE '2025-06-04'
                AND (
                  stream_id IN ('1047860114')
                  OR (stream_id = '1913717213' AND event_custom_timestamp IS NULL)
                )
                AND event_name = 'track_pseudo_complete'
              )
            )

    - name: completion_rate
      title: Completion Rate %
      type: number
      sql: "COALESCE(100.0 * {track_pseudo_complete} / NULLIF({track_play_5s}, 0), 0)"
      meta:
        suffix: ' %'

    - name: track_listen_time
      title: Listen Time
      type: sum
      sql: track_listen_time
      shown: false

    - name: listen_time_minutes
      title: Listen Time (Min)
      type: number
      sql: "ROUND(CAST({track_listen_time} AS FLOAT64)/60000.0)"

    - name: listen_time_per_user
      type: number
      title: 'Avg User Listen Time'
      sql: "COALESCE({listen_time_minutes} / NULLIF(CAST({track_play_users} AS FLOAT64), 0.0), 0.0)"

#Wayfinding Measures
    - name: wayfinding_directions
      title: Directions
      type: count
      sql: event_name
      filters:
        - sql: event_name = 'click_button'
        - sql: component_type = 'track_wayfinding'

    - name: wayfinding_directions_users
      title: Wayfinding Users
      type: count_distinct_approx
      sql: case when event_name = 'click_button' and component_type = 'track_wayfinding' then user_pseudo_id else null end
    
    - name: wayfinding_route_current
      title: Route to Current
      type: count
      sql: event_name
      filters:
        - sql: event_name = 'click_button'
        - sql: content_category = 'wayfinding'
        - sql: event_label = 'route_to_current_track'
    
    - name: wayfinding_route_next
      title: Route to Next
      type: count
      sql: event_name
      filters:
        - sql: event_name = 'click_button'
        - sql: content_category = 'wayfinding'
        - sql: event_label = 'route_to_next_track'

    - name: wayfinding_floor_plan
      title: Floor Plan
      type: count
      sql: event_name
      filters:
        - sql: event_name = 'click_button'
        - sql: content_category = 'wayfinding'
        - sql: event_label = 'floor_plan'
    
    - name: wayfinding_survey_votes
      title: Wayfinding Survey Votes
      type: count
      sql: event_name
      filters:
        - sql: event_name = 'click_icon'
        - sql: component_type = 'icon_feedback'
        - sql: contains_substr(content_category, 'wayfinding')

    - name: wayfinding_survey_positive
      title: Wayfinding Survey Positive
      type: count
      sql: event_name
      filters:
        - sql: event_name = 'click_icon'
        - sql: component_type = 'icon_feedback'
        - sql: contains_substr(content_category, 'wayfinding')
        - sql: event_label = 'positive'

    - name: wayfinding_survey_rating
      title: Wayfinding Rating %
      type: number
      sql: "COALESCE(100.0 * {wayfinding_survey_positive} / NULLIF({wayfinding_survey_votes}, 0), 0)"

      meta:
        suffix: ' %'

    - name: wayfinding_tour_user_share
      title: User Share %
      type: number
      sql: "COALESCE(100.0 * {wayfinding_directions_users} / NULLIF({tour_users}, 0), 0)"
      meta:
        suffix: ' %'

    - name: wayfinding_track_user_share
      title: Wayfinding Track %
      type: number
      sql: "COALESCE(100.0 * {wayfinding_directions_users} / NULLIF({track_play_users}, 0), 0)"
      meta:
        suffix: ' %'

    - name: numpad_hit
      title: Numpad Searches
      type: count
      sql: event_name
      filters:
        - sql: event_name = 'numpad_recognition_hit'
    
    - name: numpad_hit_users
      title: Numpad Users
      type: count_distinct_approx
      sql: user_pseudo_id
      filters:
        - sql: event_name = 'numpad_recognition_hit'

    - name: numpad_hits_per_user
      title: Avg Numpad Searhes
      type: number
      sql: "COALESCE(CAST({numpad_hit} AS FLOAT64) / NULLIF(CAST({numpad_hit_users} AS FLOAT64), 0.0), 0.0)"

  joins:
    - name: venue_lookup_tracks
      relationship: many_to_one
      sql: "{CUBE.track_id_locale} = {venue_lookup_tracks.track_sid_locale}"

    - name: venue_lookup_tracks_nump
      relationship: many_to_one
      sql: "{CUBE.track_id} = {venue_lookup_tracks_nump.track_sid}"
    
    - name: venue_lookup_tours
      relationship: many_to_one
      sql: "{CUBE.tour_id} = {venue_lookup_tours.tour_sid}"

    - name: venue_lookup_language
      relationship: many_to_one
      sql: "{CUBE.device_language} = {venue_lookup_language.device_language}"

  
  # pre_aggregations:
  #   - name: media_player_aggregation
  #     measures:
  #       - venue_dataform_tracks.tour_views
  #       - venue_dataform_tracks.tour_users
  #       - venue_dataform_tracks.track_plays
  #       - venue_dataform_tracks.track_play_users
  #       - venue_dataform_tracks.track_play_5s
  #       - venue_dataform_tracks.track_pseudo_complete
  #       - venue_dataform_tracks.track_listen_time
  #       - venue_dataform_tracks.wayfinding_directions
  #       - venue_dataform_tracks.wayfinding_directions_users
  #       - venue_dataform_tracks.wayfinding_route_current
  #       - venue_dataform_tracks.wayfinding_route_next
  #       - venue_dataform_tracks.wayfinding_floor_plan
  #       - venue_dataform_tracks.wayfinding_survey_votes
  #       - venue_dataform_tracks.wayfinding_survey_positive
  #       - venue_dataform_tracks.numpad_hit
  #       - venue_dataform_tracks.numpad_hit_users
  #     dimensions:
  #       - venue_dataform_tracks.datetime
  #       - venue_dataform_tracks.venue_id
  #       - venue_dataform_tracks.device_platform
  #       - venue_dataform_tracks.country
  #       - venue_dataform_tracks.user_connectivity
  #       - venue_dataform_tracks.user_age_range
  #       - venue_dataform_tracks.user_gender
  #       - venue_dataform_tracks.tour_id
  #       - venue_dataform_tracks.tour_type
  #       - venue_dataform_tracks.track_id
  #       - venue_dataform_tracks.track_language
  #       - venue_dataform_tracks.event_label
  #       - venue_dataform_tracks.wayfinding_survey_label
  #       - venue_lookup_tracks.track_name
  #       - venue_lookup_tracks_nump.track_name
  #       - venue_lookup_tours.tour_name
  #       - venue_lookup_language.language_name
  #     time_dimension: venue_dataform_tracks.datetime
  #     granularity: day
  #     partition_granularity: day
  #     refresh_key:
  #       every: 1 day
  #       incremental: true
  #       update_window: 1 day
  #     build_range_start: TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), MONTH), INTERVAL 13 MONTH)
  #     build_range_end: TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 2 DAY)