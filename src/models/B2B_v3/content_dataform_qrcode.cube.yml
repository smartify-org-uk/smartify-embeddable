cubes:
- name: content_dataform_qrcode
  data_source: default
  sql: >
    select
      event_date
      --,event_params_custom.event_custom_timestamp as event_custom_timestamp
      ,case 
        when is_measurement_protocol_hit = true then timestamp_seconds(event_params_custom.event_custom_timestamp)
        else timestamp_micros(time.event_timestamp)
      end as event_timestamp
      ,user_pseudo_id
      ,event_name
      ,platform
      ,is_measurement_protocol_hit
      --,device.mobile_brand_name
      ,device.category as device_category
      --,device.web_info.hostname as hostname
      ,geo.country as geo_country
      --,geo.city as geo_city
      ,stream_id
      ,event_params_custom.client_connectivity
      ,event_params_custom.component_type
      ,event_params_custom.content_category
      ,event_params_custom.page_type
      ,event_params_custom.venue_id
      ,event_params_custom.organisation_id
      ,event_params_custom.qrcode_id
      ,event_params_custom.qrcode_label
    from `smartify-cc94e.superform_outputs_151371783.ga4_events`
    where event_params_custom.qrcode_id = '{COMPILE_CONTEXT.securityContext.qrcode_id}'
      and event_name = 'qrcode_open'
      and event_date >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 13 MONTH)
      and (stream_id in ('1047860117','1047860114','1913717213','2817285551','10374153553') or (stream_id = '4029517643' and event_params_custom.organisation_id = 'org_ukparliament'))
  
  dimensions:
    - name: datetime
      type: time
      sql: event_timestamp

    - name: user_connectivity
      type: string
      sql: |-
        case
          when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
          when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
          else 'Cellular'
        end
      
    - name: device_platform
      type: string
      sql: |-
        case
          when stream_id = '1047860117' then 'iOS'
          when stream_id = '1047860114' then 'Android'
          when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
          when (stream_id = '10374153553' or (stream_id = '1913717213' and is_measurement_protocol_hit = true)) then 'Hardware'
          else 'Webapp'
        end

    - name: venue_id
      type: string
      sql: case when (venue_id = "" or venue_id is null) then "No linked venue" else venue_id end
      #primaryKey: true
      #shown: true
    
    - name: country
      type: string
      sql: if(geo_country = "", "Unknown", geo_country)

    - name: qrcode_id
      type: string
      sql: qrcode_id

    - name: qrcode_label
      type: string
      sql: qrcode_label

  measures:
    - name: qrcode_open
      type: count
      title: 'QR Code Open'
    
    - name: qrcode_users
      type: count_distinct_approx
      sql: user_pseudo_id
      title: 'QR Code Users'
  
  pre_aggregations:
    - name: general_qrcode_aggregation
      measures:
        - content_dataform_qrcode.qrcode_open
        - content_dataform_qrcode.qrcode_users
      dimensions:
        - content_dataform_qrcode.datetime
        - content_dataform_qrcode.user_connectivity
        - content_dataform_qrcode.device_platform
        - content_dataform_qrcode.venue_id
        - content_dataform_qrcode.country
        - content_dataform_qrcode.qrcode_id
        - content_dataform_qrcode.qrcode_label
      timeDimension: content_dataform_qrcode.datetime
      granularity: day