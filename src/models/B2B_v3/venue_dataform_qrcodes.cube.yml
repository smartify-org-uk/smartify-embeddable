cubes: 
  - name: venue_dataform_qrcodes
    data_source: default
    sql: >
      select
        event_date
        ,event_params_custom.event_custom_timestamp as event_custom_timestamp
        ,case 
          when is_measurement_protocol_hit = true then timestamp_seconds(event_params_custom.event_custom_timestamp)
          else timestamp_micros(time.event_timestamp)
        end as event_timestamp
        ,user_pseudo_id
        ,event_name
        ,stream_id
        ,is_measurement_protocol_hit
        ,device.category as device_category
        --,device.web_info.hostname as hostname
        ,geo.country
        --,device.language as device_language
        ,event_params_custom.client_connectivity
        --,event_params_custom.content_category
        --,event_params_custom.page_type
        ,event_params_custom.venue_id
        ,event_params_custom.organisation_id
        ,event_params_custom.qrcode_id
        ,event_params_custom.qrcode_label
        --,event_params_custom.qrcode_url
      from `smartify-cc94e.superform_outputs_151371783.ga4_events` as a
      where event_params_custom.organisation_id = '{COMPILE_CONTEXT.securityContext.organisation_id}'
        and ('{COMPILE_CONTEXT.securityContext.venue_id}' IS NULL
            or '{COMPILE_CONTEXT.securityContext.venue_id}' = ''
            or '{COMPILE_CONTEXT.securityContext.venue_id}' = 'undefined'
            or event_params_custom.venue_id in unnest(split('{COMPILE_CONTEXT.securityContext.venue_id}', ','))
        )      
        and event_name in ("qrcode_open")
        and event_date >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 13 MONTH)
        and (stream_id in ('1047860117','1047860114','1913717213','2817285551','10374153553') or (stream_id = '4029517643' and event_params_custom.organisation_id = 'org_ukparliament'))

    dimensions:
      - name: datetime
        type: time
        sql: event_timestamp

      - name: user_connectivity
        type: string
        sql: |-
          case
            when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
            when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
            else 'Cellular'
          end
        
      - name: device_platform
        type: string
        sql: |-
          case
            when stream_id = '1047860117' then 'iOS'
            when stream_id = '1047860114' then 'Android'
            when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
            when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
            else 'Webapp'
          end

      - name: country
        type: string
        sql: if(country = '', 'Unknown', country)

      - name: organisation_id
        type: string
        sql: organisation_id
      
      - name: venue_id
        type: string
        sql: case when (venue_id = "" or venue_id is null) then "No linked venue" else venue_id end

      - name: qrcode_id
        type: string
        sql: qrcode_id
        title: "QR Code ID"
        primaryKey: true
        shown: true
      
      - name: qrcode_label
        type: string
        sql: qrcode_label
        title: "QR Code Label"

    measures:
      - name: qrcode_users
        type: count_distinct_approx
        sql: user_pseudo_id
        title: "QR Code Users"

      - name: qrcode_opens
        type: count
        sql: event_name
        title: "QR Code Opens"
    
    pre_aggregations:
      - name: qrcode_aggregation
        measures:
          - venue_dataform_qrcodes.qrcode_users
          - venue_dataform_qrcodes.qrcode_opens
        dimensions:
          - venue_dataform_qrcodes.datetime
          - venue_dataform_qrcodes.venue_id
          - venue_dataform_qrcodes.organisation_id
          - venue_dataform_qrcodes.device_platform
          - venue_dataform_qrcodes.user_connectivity
          - venue_dataform_qrcodes.qrcode_label
          - venue_dataform_qrcodes.qrcode_id
          - venue_dataform_qrcodes.country
        timeDimension: venue_dataform_qrcodes.datetime
        granularity: day