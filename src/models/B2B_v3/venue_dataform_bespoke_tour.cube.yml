cubes:
- name: venue_dataform_bespoke_tour
  data_source: default
  sql: >
    select
      event_date
      ,event_params_custom.event_custom_timestamp
      ,if(event_params_custom.event_custom_timestamp is null, timestamp_micros(time.event_timestamp), timestamp_seconds(event_params_custom.event_custom_timestamp)) as event_timestamp
      ,user_pseudo_id
      ,event_name
      ,stream_id
      ,device.category as device_category
      --,device.operating_system_version
      ,geo.country as geo_country
      ,event_params_custom.client_connectivity
      --,event_params_custom.component_type
      --,event_params_custom.content_category
      ,event_params_custom.event_label
      ,event_params_custom.page_type
      ,event_params_custom.page_path
      ,event_params_custom.venue_id
      ,event_params_custom.organisation_id
      ,event_params_custom.experience_id
      ,event_params_custom.tour_id
      ,event_params_custom.track_id
      ,event_params_custom.audio_language
      ,case
        when event_params_custom.track_listen_time_string = 'inf' then 0
        else cast(event_params_custom.track_listen_time_string AS numeric)
      end AS track_listen_time
    from `smartify-cc94e.superform_outputs_151371783.ga4_events`
    where (event_params_custom.organisation_id != 'org_smithsonian' or (event_params_custom.organisation_id = 'org_smithsonian' and not contains_substr(event_params_custom.venue_id, ',')))
      and event_date >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 13 MONTH)
      and stream_id in ("1047860117","1047860114","1913717213","2817285551","10374153553")
      and (event_params_custom.tour_id = 'tour_nXWykZAxnH9pXEcZONAz' or contains_substr(event_params_custom.tour_id, 'ptour_'))
      and event_name in ('select_component','track_pause','track_start','page_view','track_start_5s','screen_view','track_resume','track_quartile_25','track_quartile_50','track_quartile_75','track_pseudo_complete','track_complete','track_forward','track_backward','session_start','click_button','first_visit','share','add_favorite','inapp_click')

      
  dimensions:
    - name: datetime
      type: time
      sql: event_timestamp

    - name: user_connectivity
      type: string
      sql: |-
        case
          when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
          when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
          else 'Cellular'
        end
      
    - name: device_platform
      type: string
      sql: |-
        case
          when stream_id = '1047860117' then 'iOS'
          when stream_id = '1047860114' then 'Android'
          when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
          when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
          else 'Webapp'
        end

    - name: organisation_id
      type: string
      sql: organisation_id
      primaryKey: true
      shown: true
    
    - name: venue_id
      type: string
      sql: case when (venue_id = "" or venue_id is null) then "No linked venue" else venue_id end

    - name: experience_id
      type: string
      sql: experience_id
      primaryKey: true
      shown: true

    - name: tour_id
      type: string
      sql: tour_id
      primaryKey: true
      shown: true

    - name: tour_type
      type: string
      sql: case when STARTS_WITH(tour_id,"ptour_") then "Bespoke Tours" when STARTS_WITH(tour_id,"tour_") then "Venue Tours" else null end
    
    - name: track_id
      type: string
      sql: track_id
    
    - name: track_id_locale
      type: string
      sql: concat(track_id, audio_language)
      primaryKey: true
      shown: false

    - name: track_language
      type: string
      sql: audio_language
    
    - name: event_label
      type: string
      sql: event_label
  
  measures:
    - name: tour_views
      type: count
      sql: event_name
      filters:
        - sql: event_name in ('page_view', 'screen_view')
        - sql: contains_substr(page_type, 'tour_dp')
    
    - name: tour_users
      type: count_distinct_approx
      sql: user_pseudo_id
      filters:
        - sql: event_name in ('page_view', 'screen_view', 'track_start')
        - sql: tour_id is not null

    - name: track_plays
      title: Plays
      type: count
      sql: event_name
      filters:
        - sql: event_name in ('track_start')

    # - name: track_complete
    #   title: Completes
    #   type: sum
    #   sql: case when event_name in ('track_complete') then 1 else 0 end

    - name: track_play_users
      type: count_distinct_approx
      sql: user_pseudo_id
      filters:
        - sql: event_name in ('track_start')

    # - name: track_complete_users
    #   type: count_distinct_approx
    #   sql: case when event_name in ('track_complete') then user_pseudo_id else null end

    # - name: track_play_per_user
    #   type: number
    #   title: 'Track Play Per User'
    #   sql: safe_divide({track_plays}, {track_play_users})
   
    - name: track_play_5s
      title: Track Plays 5s
      type: count
      sql: event_name
      filters:
        - sql: (event_date > '2025-06-11' and event_name in ('track_start_5s') or event_date <= '2025-06-11' and event_name in ('track_start'))

    - name: track_pseudo_complete
      type: count
      sql: event_name
      filters:
        - sql: |-
            (
              (event_date < DATE '2025-06-04' AND event_name = 'track_complete')
              OR
              (
                event_date >= DATE '2025-06-04'
                AND (
                  stream_id IN ('1047860117','10374153553')
                  OR (stream_id = '1913717213' AND event_custom_timestamp IS NOT NULL)
                )
                AND event_name = 'track_complete'
              )
              OR
              (
                event_date >= DATE '2025-06-04'
                AND (
                  stream_id IN ('1047860114')
                  OR (stream_id = '1913717213' AND event_custom_timestamp IS NULL)
                )
                AND event_name = 'track_pseudo_complete'
              )
            )

    - name: completion_rate
      title: Completion Rate %
      type: number
      sql: "safe_divide({track_pseudo_complete}, {track_play_5s}) * 100"
      meta:
        suffix: ' %'

    #Bespoek Tour Measures
    - name: ptour_created
      title: Bespoke Tour Created
      type: count_distinct
      sql: tour_id
      filters:
        - sql: STARTS_WITH(tour_id,"ptour_")
      #sql: case when STARTS_WITH(tour_id,"ptour_") then tour_id else null end

    - name: ptour_users
      title: Bespoke Tour Users
      type: count_distinct_approx
      sql: user_pseudo_id
      filters:
        - sql: STARTS_WITH(tour_id,"ptour_")
      #sql: case when STARTS_WITH(tour_id,"ptour_") then user_pseudo_id else null end

    - name: ptour_views
      title: Bespoke Tour Views
      type: count
      sql: event_name
      filters:
        - sql: event_name in ('page_view', 'screen_view')
        - sql: contains_substr(page_type, 'tour_dp')
        - sql: STARTS_WITH(tour_id,"ptour_")
      #sql: case when event_name in ('page_view', 'screen_view') and contains_substr(page_type, "tour_dp") and STARTS_WITH(tour_id,"ptour_") then 1 else 0 end

    # - name: ptour_track_plays
    #   title: Bespoke Track Plays
    #   type: count
    #   sql: event_name
    #   filters:
    #     - sql: event_name in ('track_start')
    #     - sql: STARTS_WITH(tour_id,"ptour_")
    #   #sql: case when event_name in ('track_start') and STARTS_WITH(tour_id,"ptour_") then 1 else 0 end
    
    # - name: ptour_track_complete
    #   title: Bespoke Track Complete
    #   type: count
    #   filters:
    #     - sql: event_name in ('track_complete')
    #     - sql: STARTS_WITH(tour_id,"ptour_")
    #   #sql: case when event_name in ('track_complete') and STARTS_WITH(tour_id,"ptour_") then 1 else 0 end

    # - name: bespoke_page_language
    #   title: Bespoke Language
    #   type: sum
    #   sql: case when event_name in ('page_view','screen_view') and contains_substr(page_path, "/create-tour/language") then 1 else 0 end

    # - name: bespoke_page_topics
    #   title: Bespoke Topics
    #   type: sum
    #   sql: case when event_name in ('page_view','screen_view') and page_path = "/create-tour/tiles" then 1 else 0 end

    # - name: bespoke_page_stops
    #   title: Bespoke Stops
    #   type: sum
    #   sql: case when event_name in ('page_view','screen_view') and page_path = "/create-tour/stops" then 1 else 0 end

    # - name: bespoke_page_duration
    #   title: Bespoke Duration
    #   type: sum
    #   sql: case when event_name in ('page_view','screen_view') and page_path = "/create-tour/duration" then 1 else 0 end

    # - name: bespoke_page_save
    #   title: Bespoke Save Tour
    #   type: sum
    #   sql: case when event_name in ('page_view','screen_view') and page_path = "/create-tour/save-tour" then 1 else 0 end
  
  joins:
    - name: venue_lookup_tracks
      relationship: many_to_one
      sql: '{CUBE.track_id_locale} = {venue_lookup_tracks.track_sid_locale}'
    
    - name: venue_lookup_tours
      relationship: many_to_one
      sql: '{CUBE.tour_id} = {venue_lookup_tours.tour_sid}'

    - name: venue_lookup_experiences
      relationship: many_to_one
      sql: '{CUBE.experience_id} = {venue_lookup_experiences.experience_id}'

  
#   pre_aggregations:
#     - name: media_player_aggregation
#       measures:
#         - venue_dataform_tracks.track_plays
#         - venue_dataform_tracks.track_play_users
#         - venue_dataform_tracks.track_complete
#         - venue_dataform_tracks.track_completion_rate
#         - venue_dataform_tracks.track_complete_users
#         - venue_dataform_tracks.track_listen_time
#         - venue_dataform_tracks.listen_time_minutes
#         - venue_dataform_tracks.tour_views
#         - venue_dataform_tracks.tour_users
#       dimensions:
#         - venue_dataform_tracks.device_platform
#         - venue_dataform_tracks.user_connectivity
#         - venue_dataform_tracks.venue_id
#         - venue_dataform_tracks.track_id
#         - venue_dataform_tracks.tour_id
#         - venue_dataform_tracks.track_language
#         - venue_dataform_tracks.country
#         - venue_dataform_tracks.user_age_range
#         - venue_dataform_tracks.user_gender
#         - venue_lookup_tracks.track_name
#         - venue_lookup_tours.tour_name
#         - venue_lookup_language.language_name
#       timeDimension: venue_dataform_tracks.event_date
#       granularity: day