cubes:
  - name: venue_dataform_activity_planner
    data_source: default
    sql: >
      select
        event_date
        ,event_params_custom.event_custom_timestamp
        ,case 
          when is_measurement_protocol_hit = true then timestamp_seconds(event_params_custom.event_custom_timestamp) 
          else timestamp_micros(time.event_timestamp)
        end as event_timestamp
        ,user_pseudo_id
        ,user_id
        ,event_name
        ,platform
        ,device.category as device_category
        --,device.web_info.hostname as hostname
        --,device.mobile_brand_name
        ,stream_id
        ,event_params_custom.client_connectivity
        ,event_params_custom.component_type
        ,event_params_custom.content_category
        --,event_params_custom.page_type
        ,event_params_custom.venue_id
        ,event_params_custom.organisation_id
        ,event_params_custom.object_id
        ,event_params_custom.tour_id
        ,event_params_custom.track_id
        ,event_params_custom.exhibition_id
        ,event_params_custom.artist_id
        ,event_params_custom.zone_id
        ,event_params_custom.visit_id
        ,PARSE_DATE('%d-%m-%Y', event_params_custom.visit_date) as visit_date
        ,event_params_custom.visit_duration
        ,event_params_custom.visit_family_friendly
        ,event_params_custom.visit_special_assistant
        ,event_params_custom.page_content_id
        ,if(contains_substr(event_params_custom.page_content_id, 'usrvst_'), event_params_custom.page_content_id, null) as user_visit_id
        --,event_params_custom.page_path
        --,event_params_custom.event_label
        ,device.language as device_language
      from `smartify-cc94e.superform_outputs_151371783.ga4_events`
      where event_params_custom.organisation_id = '{COMPILE_CONTEXT.securityContext.organisation_id}'
      /*
      and ('{COMPILE_CONTEXT.securityContext.venue_id}' IS NULL
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = ''
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = 'undefined'
          or event_params_custom.venue_id in unnest(split('{COMPILE_CONTEXT.securityContext.venue_id}', ',')))
      */
      and (event_params_custom.organisation_id != 'org_smithsonian' or (event_params_custom.organisation_id = 'org_smithsonian' and not contains_substr(event_params_custom.venue_id, ',')))
      and event_date >= '2025-07-01'
      --and event_name != "view_component"
      and event_name in ('view_component','select_component','page_view','click_tab','screen_view','click_button','share')
      and (stream_id in ('1047860117','1047860114','1913717213','2817285551','10374153553') or (stream_id = '4029517643' and event_params_custom.organisation_id = 'org_ukparliament'))

    dimensions:
      - name: datetime
        type: time
        sql: event_timestamp
          
      - name: user_connectivity
        type: string
        sql: |-
          case
            when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
            when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
            else 'Cellular'
          end
        
      - name: device_platform
        type: string
        sql: |-
          case
            when stream_id = '1047860117' then 'iOS'
            when stream_id = '1047860114' then 'Android'
            when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
            when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
            else 'Webapp'
          end

      - name: device_language
        type: string
        sql: device_language
        primaryKey: true
        shown: false

      - name: organisation_id
        type: string
        sql: organisation_id
        primaryKey: true
        shown: true
      
      - name: venue_id
        type: string
        sql: case when (venue_id = "" or venue_id is null) then "No linked venue" else venue_id end
      
      - name: content_category
        type: string
        sql: content_category

      - name: object_id
        type: string
        sql: object_id

      - name: content_id
        type: string
        sql: case when content_category = 'object' then object_id when content_category = 'tour' then tour_id when  contains_substr(content_category, 'track') then track_id when content_category = 'exhibition' then exhibition_id when content_category = 'artist' then artist_id when content_category = 'zone' then zone_id when content_category = 'venue' then venue_id when content_category = 'organisation_id' then organisation_id else null end

      - name: visit_id
        type: string
        sql: visit_id
      
      - name: user_visit_id
        type: string
        sql: user_visit_id

      - name: visit_date
        type: time
        sql: timestamp(visit_date)

      - name: visit_duration
        type: string
        sql: visit_duration
      
      - name: visit_family_friendly
        type: string
        sql: visit_family_friendly
      
      - name: visit_special_assistant
        type: string
        sql: visit_special_assistant

      - name: zone_id
        type: string
        sql: zone_id
        primaryKey: true
        shown: true

    measures:
      - name: visits_created
        type: count_distinct_approx
        sql: user_visit_id

      - name: visit_users
        type: count_distinct_approx
        sql: user_id

      - name: active_user
        type: count_distinct_approx
        title: Total Users
        sql: user_pseudo_id

      - name: expand_group_card
        type: count
        title: Expand
        sql: event_name
        filters:
          - sql: event_name = 'collapse_component'
          - sql: component_type = 'activity_group_card'
      
      - name: collapse_group_card
        type: count
        title: Collapse
        sql: event_name
        filters:
          - sql: event_name = 'collapse_component'
          - sql: component_type = 'activity_group_card'
      
      - name: select_card
        type: count
        title: Open Content
        sql: event_name
        filters:
          - sql: event_name = 'select_component'
          - sql: component_type = 'activity_card'
      
      - name: complete_content
        type: count
        title: Complete
        sql: event_name
        filters:
          - sql: event_name = 'complete_content'
          - sql: component_type in ('activity_card', 'activity_group_card')
    
    joins:
      - name: venue_lookup_zones
        relationship: many_to_one
        sql: '{CUBE.zone_id} = {venue_lookup_zones.zone_sid}'
      
      - name: venue_lookup_objects
        relationship: many_to_one
        sql: 'if(contains_substr({CUBE.content_id}, "ak_"), {CUBE.content_id} = {venue_lookup_objects.object_sid}, {CUBE.content_id} = {venue_lookup_objects.object_sid})'

    # pre_aggregations:
    #   - name: activity_planner_aggregation
    #     measures:
    #       - venue_dataform_activity_planner.visits_created
    #       - venue_dataform_activity_planner.visit_users
    #       - venue_dataform_activity_planner.active_user
    #       - venue_dataform_activity_planner.expand_group_card
    #       - venue_dataform_activity_planner.collapse_group_card
    #       - venue_dataform_activity_planner.select_card
    #       - venue_dataform_activity_planner.complete_content
          
    #     dimensions:
    #       - venue_dataform_activity_planner.datetime
    #       - venue_dataform_activity_planner.device_platform
    #       - venue_dataform_activity_planner.user_connectivity
    #       - venue_dataform_activity_planner.device_language
    #       - venue_dataform_activity_planner.organisation_id
    #       - venue_dataform_activity_planner.venue_id
    #       - venue_dataform_activity_planner.content_category
    #       - venue_dataform_activity_planner.content_id
    #       - venue_dataform_activity_planner.visit_id
    #       - venue_dataform_activity_planner.user_visit_id
    #       - venue_dataform_activity_planner.visit_date
    #       - venue_dataform_activity_planner.visit_duration
    #       - venue_dataform_activity_planner.visit_family_friendly
    #       - venue_dataform_activity_planner.visit_special_assistant
    #       - venue_dataform_activity_planner.zone_id
    #       #- venue_lookup_objects.object_name
    #       #- venue_lookup_artists.artist_name
    #       #- venue_lookup_language.language_name
    #     timeDimension: venue_dataform_activity_planner.datetime
    #     granularity: day