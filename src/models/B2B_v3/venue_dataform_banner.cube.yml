cubes:
- name: venue_dataform_banner
  data_source: default
  sql: >
    select
      event_date
      ,case 
        when is_measurement_protocol_hit = true then timestamp_seconds(event_params_custom.event_custom_timestamp) 
        else timestamp_micros(time.event_timestamp)
      end as event_timestamp
      ,user_pseudo_id
      ,event_name
      ,stream_id
      ,is_measurement_protocol_hit
      ,device.category as device_category
      --,device.web_info.hostname as hostname
      --,geo.country as geo_country
      --,device.language as device_language
      ,event_params_custom.client_connectivity
      --,event_params_custom.content_category
      ,event_params_custom.component_type
      --,event_params_custom.page_type
      ,event_params_custom.venue_id
      ,event_params_custom.organisation_id
      --,event_params_custom.event_label
      ,event_params_custom.location_id
      ,event_params_custom.banner_id
      ,event_params_custom.banner_item_id
    from `smartify-cc94e.superform_outputs_151371783.ga4_events`
    where event_params_custom.organisation_id = '{COMPILE_CONTEXT.securityContext.organisation_id}'
      and ('{COMPILE_CONTEXT.securityContext.venue_id}' IS NULL
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = ''
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = 'undefined'
          or event_params_custom.venue_id in unnest(split('{COMPILE_CONTEXT.securityContext.venue_id}', ','))
      )
      and event_date >= '2025-03-28'
      and stream_id in ("1047860117","1047860114","1913717213","2817285551","10374153553")
      and event_params_custom.banner_id is not null
      and event_name in ('select_component', 'view_component', 'click_button', 'session_start', 'first_visit')

  dimensions:
    - name: datetime
      type: time
      sql: event_timestamp

    - name: user_connectivity
      type: string
      sql: |-
        case
          when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
          when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
          else 'Cellular'
        end
        
    - name: device_platform
      type: string
      sql: |-
        case
          when stream_id = '1047860117' then 'iOS'
          when stream_id = '1047860114' then 'Android'
          when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
          when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
          else 'Webapp'
        end
     
    - name: organisation_id
      type: string
      sql: organisation_id
    
    - name: venue_id
      type: string
      sql: case when (venue_id = "" or venue_id is null) then "No linked venue" else venue_id end

    - name: location_id_prefix
      type: string
      sql: |-
        case 
          when location_id = "venue_feed" then "venue_dp" 
          when location_id = "exhibition:feed" then "exhibition_dp" 
          when location_id = "org:feed" then "org_dp"
          else REGEXP_EXTRACT(location_id, r'^([^:]+)')
        end
      #sql: REGEXP_EXTRACT({location_id}, r'^([^:]+)')
      title: Banner Placement

    - name: component_type
      type: string
      sql: component_type

    - name: banner_action
      type: string
      sql: |-
        case 
          when contains_substr(content_category, ":") then REGEXP_EXTRACT(content_category, r':(.*)') 
          when content_category = "campaign" then 'OpenUrl'
          else content_category
        end
      title: Banner Action
    
    - name: banner_id
      type: string
      sql: banner_id
      primaryKey: true
      shown: true

    - name: banner_item_id
      type: string
      sql: banner_item_id
      primaryKey: true
      shown: true

  measures:
    - name: active_users
      type: count_distinct_approx
      title: "Total Users"
      sql: user_pseudo_id

    - name: banner_impressions
      type: count
      title: "Impressions"
      sql: event_name
      filters:
        - sql: event_name = 'view_component'
    
    - name: banner_clicks
      type: count
      title: "Clicks"
      sql: event_name
      filters:
        - sql: event_name in ('select_component', 'click_button', 'click_link', 'click_banner')
    
    - name: banner_ctr
      type: number
      title: "CTR"
      sql: "safe_divide({banner_clicks}, {banner_impressions}) * 100"
      meta:
        suffix: '%'

    - name: banner_impressions_per_user
      type: number
      title: "Impressions per User"
      sql: "safe_divide({banner_impressions}, {active_users})"
    
  joins:
    - name: venue_lookup_banners
      relationship: many_to_one
      sql: '{CUBE.banner_id} = {venue_lookup_banners.banner_id}'
    
    - name: venue_lookup_banner_slides
      relationship: many_to_one
      sql: '{CUBE.banner_item_id} = {venue_lookup_banner_slides.banner_slide_id}'