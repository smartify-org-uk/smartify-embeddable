cubes:
  - name: venue_dataform_timelines
    sql: |-
      select
        event_date
        ,event_params_custom.event_custom_timestamp
        ,if(event_params_custom.event_custom_timestamp is null, timestamp_micros(time.event_timestamp), timestamp_seconds(event_params_custom.event_custom_timestamp)) as event_timestamp
        ,user_pseudo_id
        ,event_name
        ,stream_id
        ,device.category as device_category
        ,event_params_custom.client_connectivity
        ,event_params_custom.component_type
        ,event_params_custom.content_category
        ,event_params_custom.page_type
        ,event_params_custom.organisation_id
        ,event_params_custom.venue_id
        ,event_params_custom.timeline_id
        ,event_params_custom.timeline_event_id
        ,event_params_custom.timeline_period_id
      from `smartify-cc94e.superform_outputs_151371783.ga4_events`
        where 
        event_params_custom.organisation_id = '{COMPILE_CONTEXT.securityContext.organisation_id}'
        and ('{COMPILE_CONTEXT.securityContext.venue_id}' IS NULL
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = ''
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = 'undefined'
          or event_params_custom.venue_id in unnest(split('{COMPILE_CONTEXT.securityContext.venue_id}', ','))
        ) and
        event_date between "2025-08-01" and "2025-08-31" and
        (stream_id in ('1047860117','1047860114','1913717213','2817285551','10374153553') or (stream_id = '4029517643' and event_params_custom.organisation_id = 'org_ukparliament')) and
        event_params_custom.timeline_id is not null and
        event_name in ("view_component","select_component","page_view","session_start","click_tab","screen_view","click_button","first_visit","share")
    
    dimensions:
      - name: event_date
        type: time
        sql: event_timestamp
      
      - name: user_connectivity
        type: string
        sql: |-
          case
            when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
            when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
            else 'Cellular'
          end
        
      - name: device_platform
        type: string
        sql: |-
          case
            when stream_id = '1047860117' then 'iOS'
            when stream_id = '1047860114' then 'Android'
            when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
            when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
            else 'Webapp'
          end

      - name: organisation_id
        type: string
        sql: organisation_id
      
      - name: venue_id
        type: string
        sql: venue_id

      - name: timeline_id
        type: string
        sql: timeline_id
        primaryKey: true
        shown: true

      - name: timeline_period_id
        type: string
        sql: ifnull(timeline_period_id, '')
        primaryKey: true
        shown: true

      - name: timeline_event_id
        type: string
        sql: ifnull(timeline_event_id, '')
        primaryKey: true
        shown: true

    measures:      
      - name: total_users
        type: count_distinct_approx
        sql: user_pseudo_id
        filters:
          - sql: event_name in ('screen_view', 'page_view')
          - sql: page_type = 'timeline_dp'
      
      - name: timeline_banner_clicks
        type: count
        sql: event_name
        filters:
          - sql: event_name = 'select_component'
          - sql: component_type = 'banner_large'
          - sql: content_category = 'timeline'        

      - name: timeline_banner_impressions
        type: count
        sql: event_name
        filters:
          - sql: event_name = 'view_component'
          - sql: contains_substr(component_type, 'banner_large')
          - sql: content_category = 'timeline'

      - name: timeline_banner_ctr
        type: number
        sql: "COALESCE(100.0 * {timeline_banner_clicks} / NULLIF({timeline_banner_impressions}, 0), 0)"
        meta:
          - suffix: '%'

      - name: timeline_views
        type: count
        sql: event_name
        filters:
          - sql: event_name in ('screen_view', 'page_view')
          - sql: page_type = 'timeline_dp'
      
      - name: select_timeline_event
        type: count
        sql: event_name
        filters:
          - sql: event_name = 'select_component'
          - sql: timeline_event_id is not null
      
      - name: timeline_period_tab_click
        type: count
        sql: event_name
        filters:
          - sql: event_name = 'click_tab'
          - sql: timeline_period_id is not null      

    joins:
      - name: venue_lookup_timeline
        relationship: many_to_one
        sql: '{CUBE}.timeline_id = {venue_lookup_timeline.timeline_id}'
      - name: venue_lookup_timeline_period
        relationship: many_to_one
        sql: '{CUBE}.timeline_period_id = {venue_lookup_timeline_period.timeline_period_id}'
      - name: venue_lookup_timeline_period_item
        relationship: many_to_one
        sql: '{CUBE}.timeline_event_id = {venue_lookup_timeline_period_item.timeline_event_id}'
    
    # pre_aggregations:
    #   - name: timeline_aggregation
    #     measures:
    #       - venue_dataform_timelines.total_users
    #       - venue_dataform_timelines.timeline_banner_clicks
    #       - venue_dataform_timelines.timeline_banner_impressions
    #       - venue_dataform_timelines.timeline_views
    #       - venue_dataform_timelines.select_timeline_event
    #       - venue_dataform_timelines.timeline_period_tab_click
    #     dimensions:
    #       - venue_dataform_timelines.event_date
    #       - venue_dataform_timelines.venue_id
    #       - venue_dataform_timelines.device_platform
    #       - venue_dataform_timelines.user_connectivity
    #       - venue_dataform_timelines.timeline_id
    #       - venue_dataform_timelines.timeline_period_id
    #       - venue_dataform_timelines.timeline_event_id
    #       - venue_lookup_timeline_period_item.timeline_event_name
    #       - venue_lookup_timeline_period.timeline_period_name
    #       - venue_lookup_timeline.timeline_name
    #       - venue_lookup_timeline.timeline_status
    #     timeDimension: venue_dataform_timelines.event_date
    #     granularity: day