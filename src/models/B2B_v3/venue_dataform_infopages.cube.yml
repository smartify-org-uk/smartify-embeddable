cubes:
  - name: venue_dataform_infopages
    sql: |-
      select
        event_date
        ,event_params_custom.event_custom_timestamp
        ,case 
          when is_measurement_protocol_hit = true then timestamp_seconds(event_params_custom.event_custom_timestamp) 
          else timestamp_micros(time.event_timestamp)
        end as event_timestamp
        ,user_pseudo_id
        ,event_name
        ,stream_id
        ,event_params_custom.client_connectivity
        ,device.category as device_category
        ,event_params_custom.event_label
        ,event_params_custom.page_type
        ,event_params_custom.organisation_id
        ,event_params_custom.venue_id
        ,event_params_custom.location_id
        --,event_params_custom.location_index
        ,event_params_custom.info_id
      from `smartify-cc94e.superform_outputs_151371783.ga4_events`
        where event_params_custom.organisation_id = '{COMPILE_CONTEXT.securityContext.organisation_id}'
        and ('{COMPILE_CONTEXT.securityContext.venue_id}' IS NULL
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = ''
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = 'undefined'
          or event_params_custom.venue_id in unnest(split('{COMPILE_CONTEXT.securityContext.venue_id}', ','))
        )
        and event_date >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 13 MONTH)
        and stream_id in ("1047860117","1047860114","1913717213","2817285551","10374153553")
        and event_params_custom.info_id is not null
        and event_name in ('click_link','page_view','click_tab','screen_view','select_component','session_start','first_visit','share')
    
    dimensions:
      - name: datetime
        type: time
        sql: event_timestamp

      - name: user_connectivity
        type: string
        sql: |-
          case
            when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
            when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
            else 'Cellular'
          end
        
      - name: device_platform
        type: string
        sql: |-
          case
            when stream_id = '1047860117' then 'iOS'
            when stream_id = '1047860114' then 'Android'
            when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
            when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
            else 'Webapp'
          end

      - name: event_label
        type: string
        sql: event_label

      - name: organisation_id
        type: string
        sql: organisation_id
      
      - name: venue_id
        type: string
        sql: venue_id
      
      - name: info_id
        type: string
        sql: info_id
        primaryKey: true
        shown: true
      
      - name: location_id
        type: string
        sql: location_id
      
      # - name: location_index
      #   type: number
      #   sql: location_index
    
    measures:   
      - name: total_users
        type: count_distinct_approx
        sql: user_pseudo_id

      - name: info_views
        type: count
        sql: event_name
        filters:
          - sql: event_name in ('screen_view','page_view')
          - sql: page_type = 'info_dp'
      
      - name: click_tabs
        type: count
        sql: event_name
        filters:
          - sql: event_name = 'click_tab'

    joins:
      - name: venue_lookup_infopages
        relationship: many_to_one
        sql: '{CUBE}.info_id = {venue_lookup_infopages.info_id}'
      
    pre_aggregations:
      - name: info_page_aggregation
        measures:
          - venue_dataform_infopages.total_users
          - venue_dataform_infopages.info_views
          - venue_dataform_infopages.click_tabs
        dimensions:
          - venue_dataform_infopages.datetime
          - venue_dataform_infopages.venue_id
          - venue_dataform_infopages.organisation_id
          - venue_dataform_infopages.device_platform
          - venue_dataform_infopages.user_connectivity
          - venue_dataform_infopages.event_label
          - venue_dataform_infopages.info_id
          - venue_dataform_infopages.location_id
          - venue_lookup_infopages.info_name
        timeDimension: venue_dataform_infopages.datetime
        granularity: day
