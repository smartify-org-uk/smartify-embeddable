cubes:
  - name: venue_dataform_exhibition
    data_source: default
    sql: >
      select
        event_date
        ,event_params_custom.event_custom_timestamp
        ,case 
          when is_measurement_protocol_hit = true then timestamp_seconds(event_params_custom.event_custom_timestamp) 
          else timestamp_micros(time.event_timestamp)
        end as event_timestamp
        ,user_pseudo_id
        ,event_name
        ,stream_id
        ,is_measurement_protocol_hit
        ,device.category as device_category
        ,event_params_custom.client_connectivity
        ,event_params_custom.content_category
        ,event_params_custom.page_type
        ,event_params_custom.venue_id
        ,event_params_custom.organisation_id
        ,event_params_custom.exhibition_id
      from `smartify-cc94e.superform_outputs_151371783.ga4_events` where
      event_params_custom.organisation_id =
      '{COMPILE_CONTEXT.securityContext.organisation_id}'
        /*
        and ('{COMPILE_CONTEXT.securityContext.venue_id}' IS NULL
            or '{COMPILE_CONTEXT.securityContext.venue_id}' = ''
            or '{COMPILE_CONTEXT.securityContext.venue_id}' = 'undefined'
            or event_params_custom.venue_id in unnest(split('{COMPILE_CONTEXT.securityContext.venue_id}', ',')))
        */
        and (event_params_custom.organisation_id != 'org_smithsonian' or (event_params_custom.organisation_id = 'org_smithsonian' and not contains_substr(event_params_custom.venue_id, ',')))
        and event_date >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 13 MONTH)
        and (stream_id in ('1047860117','1047860114','1913717213','2817285551','10374153553') or (stream_id = '4029517643' and event_params_custom.organisation_id = 'org_ukparliament'))
        and event_params_custom.exhibition_id is not null
        and event_name in ('page_view', 'screen_view', 'click_button','add_favorite')

    dimensions:
      - name: datetime
        type: time
        sql: event_timestamp

      - name: user_connectivity
        type: string
        sql: |-
          case
            when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
            when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
            else 'Cellular'
          end

      - name: device_platform
        type: string
        sql: |-
          case
            when stream_id = '1047860117' then 'iOS'
            when stream_id = '1047860114' then 'Android'
            when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
            when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
            else 'Webapp'
          end

      - name: organisation_id
        type: string
        sql: organisation_id

      - name: venue_id
        type: string
        sql: case when (venue_id = '' or venue_id is null) then 'No linked venue' else
          venue_id end

      - name: exhibition_id
        type: string
        sql: exhibition_id
        primaryKey: true
        shown: true

    measures:
      - name: exhibition_users
        type: count_distinct_approx
        title: 'Users'
        sql: user_pseudo_id
        filters:
          - sql: event_name in ('screen_view', 'page_view')
          - sql: contains_substr(page_type, 'exhibition_dp')

      - name: exhibition_views
        type: count
        title: 'Views'
        sql: event_name
        filters:
          - sql: event_name in ('screen_view', 'page_view')
          - sql: contains_substr(page_type, 'exhibition_dp')

      - name: exhibition_clicks
        type: count
        title: 'Clicks'
        sql: event_name
        filters:
          - sql: event_name in ('click_button')
          - sql: exhibition_id is not null
          - sql: content_category = 'exhibition'

      - name: exhibition_favorites
        type: count
        title: 'Favorites'
        sql: event_name
        filters:
          - sql: event_name in ('add_favorite')
          - sql: exhibition_id is not null

      - name: exhibition_ctr
        type: number
        title: 'Exhibition CTR'
        sql: "COALESCE(100.0 * {exhibition_clicks} / NULLIF({exhibition_views}, 0), 0)"
        meta:
          suffix: '%'

    joins:
      - name: venue_lookup_exhibitions
        relationship: many_to_one
        sql: "{CUBE.exhibition_id} = {venue_lookup_exhibitions.exhibition_sid}"

    # pre_aggregations:
    #   - name: exhibition_aggregation
    #     measures:
    #       - venue_dataform_exhibition.exhibition_users
    #       - venue_dataform_exhibition.exhibition_views
    #       - venue_dataform_exhibition.exhibition_clicks
    #       - venue_dataform_exhibition.exhibition_favorites
    #     dimensions:
    #       - venue_dataform_exhibition.datetime
    #       - venue_dataform_exhibition.device_platform
    #       - venue_dataform_exhibition.user_connectivity
    #       - venue_dataform_exhibition.venue_id
    #       - venue_dataform_exhibition.exhibition_id
    #       - venue_lookup_exhibitions.exhibition_name
    #       - venue_lookup_exhibitions.exhibition_start
    #       - venue_lookup_exhibitions.exhibition_end
    #     timeDimension: venue_dataform_exhibition.datetime
    #     granularity: day