cubes:
- name: venue_dataform_overall
  data_source: default
  sql: >
    select
      event_date
      ,event_params_custom.event_custom_timestamp
      ,if(event_params_custom.event_custom_timestamp is null, timestamp_micros(time.event_timestamp), timestamp_seconds(event_params_custom.event_custom_timestamp)) as event_timestamp
      ,user_pseudo_id
      --,is_active_user
      ,event_name
      ,stream_id
      ,device.category as device_category
      ,device.language as device_language
      ,geo.country
      ,safe_cast(user_properties.user_age as int64) as user_age
      --,user_properties.user_language
      ,user_properties.user_gender
      ,ifnull(user_properties.user_logged, 'false') as user_logged
      ,event_params_custom.client_connectivity
      --,collected_traffic_source.manual_content as utm_content
      --,collected_traffic_source.manual_term as utm_term
      --,event_params_custom.event_label
      ,event_params_custom.page_type
      ,event_params_custom.venue_id
      ,event_params_custom.organisation_id
      ,event_params_custom.object_id
      ,"User Type" as user_type
      ,case
        when event_params_custom.track_listen_time_string = 'inf' then 0
        else CAST(event_params_custom.track_listen_time_string AS NUMERIC)
      END AS track_listen_time
    from `smartify-cc94e.superform_outputs_151371783.ga4_events`
    where event_params_custom.organisation_id = '{COMPILE_CONTEXT.securityContext.organisation_id}'
      and ('{COMPILE_CONTEXT.securityContext.venue_id}' IS NULL
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = ''
          or '{COMPILE_CONTEXT.securityContext.venue_id}' = 'undefined'
          or event_params_custom.venue_id in unnest(split('{COMPILE_CONTEXT.securityContext.venue_id}', ','))
      )
      and (event_params_custom.organisation_id != 'org_smithsonian' or (event_params_custom.organisation_id = 'org_smithsonian' and not contains_substr(event_params_custom.venue_id, ',')))
      and event_date >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 13 MONTH)
      and stream_id in ('1047860117','1047860114','1913717213','2817285551','10374153553')
      and not (
          event_params_custom.event_custom_timestamp is not null 
          and DATE(TIMESTAMP_SECONDS(event_params_custom.event_custom_timestamp)) = '2025-06-06'
          and stream_id = '1913717213'
          and device.mobile_brand_name =  'Smartify'
      )

  dimensions:
    - name: datetime
      type: time
      sql: event_timestamp

    - name: user_connectivity
      type: string
      sql: |-
        case
          when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
          when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
          else 'Cellular'
        end
        
    - name: device_platform
      type: string
      sql: |-
        case
          when stream_id = '1047860117' then 'iOS'
          when stream_id = '1047860114' then 'Android'
          when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
          when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
          else 'Webapp'
        end

    # - name: user_pseudo_id
    #   type: string
    #   sql: user_pseudo_id

    - name: stream_id
      type: string
      sql: stream_id

    - name: device_language
      type: string
      sql: device_language
      primaryKey: true
      shown: false
    
    # - name: user_language
    #   type: string
    #   sql: user_language

    - name: country
      type: string
      sql: if(country = '', 'Unknown', country)

    - name: user_gender
      type: string
      sql: |-
        case 
          when user_gender in ('Male', 'MALE', 'Man', 'Mand', 'Masculino', '男性', 'זכר', 'Männlich', 'Mann', 'Homme', 'Hombre') then 'Male' 
          when user_gender in ('Female', 'Woman', 'Femme', 'Mujer', 'Vrouw', 'Weiblich', 'Frau', 'Feminino', '女性', 'Donna', 'Kvinde') then 'Female' 
          when user_gender in ('Unspecified', 'Non spécifié', 'Sin especificar') then 'Unspecified' 
          when user_gender in ('Other', 'Autre') then 'Other'
          else 'Unknown'
        end


    - name: user_age_range
      type: string
      sql: |-
        case
          when user_age < 18 then '- 18'
          when user_age >= 18 and user_age < 25 then '18 - 24'
          when user_age >= 25 and user_age < 35 then '25 - 34'
          when user_age >= 35 and user_age < 45 then '35 - 44'
          when user_age >= 45 and user_age < 55 then '45 - 54'
          when user_age >= 55 and user_age < 65 then '55 - 64'
          when user_age >= 65 and user_age < 71 then '65 - 70'
          when user_age >= 71 then '71+' 
          else 'Unknown'
        end

    # - name: user_generation
    #   type: string
    #   sql: case when cast(user_age as int) >= 0 and cast(user_age as int) <= 12 then 'Generation Alpha' when cast(user_age as int) >= 13 and cast(user_age as int) <= 28 then 'Generation Z' when cast(user_age as int) >= 29 and cast(user_age as int) <= 44 then 'Millennials' when cast(user_age as int) >= 45 and cast(user_age as int) <= 60 then 'Generation X' when cast(user_age as int) >= 61 and cast(user_age as int) <= 79 then 'Baby Boomers' when cast(user_age as int) >= 80 then 'Silent Generation' else 'Unknown' end

    - name: organisation_id
      type: string
      sql: organisation_id
    
    - name: venue_id
      type: string
      sql: case when (venue_id = '' or venue_id is null) then 'No linked venue' else venue_id end

    - name: user_type
      type: string
      sql: user_type

    # #SURVEY DATA
    # - name: satisfaction_vote_label
    #   type: string
    #   sql: case when (utm_content = 'Satisfaction Survey' and event_label = 'Thumbs up') then 'positive' when (utm_content = 'Satisfaction Survey' and event_label = 'Thumbs down') then 'negative' end
  
    # - name: negative_feedback_label
    #   type: string
    #   title: Negative Reason
    #   sql: case when (utm_content = 'Negative Feedback Tiles') then utm_term else null end
    
    # - name: negative_feedback_option
    #   type: string
    #   title: Option
    #   sql: case when (utm_content = 'Negative Feedback Tiles') then event_label else null end
    
  measures:
    - name: active_user
      type: count_distinct_approx
      title: Total Users
      sql: user_pseudo_id
      filters:
        - sql: event_name not in ('view_component','email_sent', 'in_app_sent', 'email_delivered', 'email_opened', 'in_app_opened', 'in_app_clicked', 'unsubscribe', 'push_opened', 'Email_Link_Clicked', 'push_sent', 'push_delivered')

    - name: audience_reach
      title: Audience Reach
      type: count_distinct_approx
      sql: user_pseudo_id

    - name: login_users
      type: count_distinct_approx
      title: Login Users
      sql: user_pseudo_id
      filters:
        - sql: user_logged = 'true'
        #- sql: is_active_user = true
    
    - name: total_actions
      type: count
      sql: event_name

    - name: actions_per_user
      title: Events per User
      type: number
      #sql: round(safe_divide({total_actions}, {active_user}), 2)
      sql: "COALESCE(CAST({total_actions} AS DOUBLE) / NULLIF(CAST({active_user} AS DOUBLE), 0.0), 0.0)"
      #sql: "COALESCE({total_actions} / NULLIF({active_user}, 0), 0)"


    #CONTENT DATA
    #Object
    - name: object_views
      type: count
      sql: event_name
      filters:
        - sql: event_name in ('page_view', 'screen_view')
        - sql: contains_substr(page_type, 'object_dp')

    - name: object_views_users
      type: count_distinct_approx
      title: Object View Users
      sql: user_pseudo_id
      filters:
        - sql: event_name in ('page_view', 'screen_view')
        - sql: contains_substr(page_type, 'object_dp')

    - name: object_views_per_user
      title: Objectect View / User
      type: number
      #sql: safe_divide({object_views}, {object_views_users})
      sql: "COALESCE(CAST({object_views} AS DOUBLE) / NULLIF(CAST({object_views_users} AS DOUBLE), 0.0), 0.0)"
      #sql: "COALESCE({object_views} / NULLIF({object_views_users}, 0), 0)"
    
    - name: object_scans
      type: count
      title: Object Scans
      sql: event_name
      filters:
        - sql: event_name = 'scan_recognition_hit'
        - sql: object_id is not null

    - name: object_scans_users
      type: count_distinct_approx
      title: Object Scan Users
      sql: user_pseudo_id
      filters:
        - sql: event_name = 'scan_recognition_hit'
        - sql: object_id is not null

    - name: object_scans_per_user
      title: Object Scan / User
      type: number
      #sql: safe_divide({object_scans}, {object_scans_users})
      sql: "COALESCE(CAST({object_scans} AS DOUBLE) / NULLIF(CAST({object_scans_users} AS DOUBLE), 0.0), 0.0)"
      #sql: "COALESCE({object_scans} / NULLIF({object_scans_users}, 0), 0)"

    
    #Exhibition
    - name: exhibition_views
      type: count
      sql: event_name
      filters:
        - sql: event_name in ('screen_view', 'page_view')
        - sql: contains_substr(page_type, 'exhibition_dp')
    
    - name: exhibition_views_users
      type: count_distinct_approx
      title: Exh View Users
      sql: user_pseudo_id 
      filters:
        - sql: event_name in ('screen_view', 'page_view')
        - sql: contains_substr(page_type, 'exhibition_dp')

    - name: exhibition_views_per_user
      title: Exhibition View / User
      type: number
      #sql: safe_divide({exhibition_views}, {exhibition_views_users})
      sql: "COALESCE(CAST({exhibition_views} AS DOUBLE) / NULLIF(CAST({exhibition_views_users} AS DOUBLE), 0.0), 0.0)"
      #sql: "COALESCE({exhibition_views} / NULLIF({exhibition_views_users}, 0), 0)"

    
    #Tours and Tracks
    - name: tour_views
      type: count
      title: Tour Views
      sql: event_name
      filters:
        - sql: event_name in ('page_view', 'screen_view')
        - sql: contains_substr(page_type, 'tour_dp')
    
    - name: tour_view_users
      type: count_distinct_approx
      title: Tour View Users
      sql: user_pseudo_id
      filters:
        - sql: event_name in ('page_view', 'screen_view')
        - sql: contains_substr(page_type, 'tour_dp')

    - name: tour_views_per_user
      title: Tour View / User
      type: number
      #sql: safe_divide({tour_views}, {tour_view_users})
      sql: "COALESCE(CAST({tour_views} AS DOUBLE) / NULLIF(CAST({tour_view_users} AS DOUBLE), 0.0), 0.0)"
      #sql: "COALESCE({tour_views} / NULLIF({tour_view_users}, 0), 0)"

    - name: track_plays
      type: count
      title: Track Plays
      sql: event_name
      filters:
        - sql: event_name in ('track_start')

    - name: track_play_users
      type: count_distinct_approx
      title: Track Play Users
      sql: user_pseudo_id
      filters:
        - sql: event_name in ('track_start')

    - name: track_plays_per_user
      title: Track Play / User
      type: number
      sql: "COALESCE(CAST({track_plays} AS DOUBLE) / NULLIF(CAST({track_play_users} AS DOUBLE), 0.0), 0.0)"
      #sql: "COALESCE({track_plays} / NULLIF({track_play_users}, 0), 0)"
      #sql: safe_divide({track_plays}, {track_play_users})
    
    - name: track_listen_time
      title: Listen Time
      type: sum
      sql: track_listen_time

    - name: listen_time_minutes
      title: Listen Time (Min)
      type: number
      sql: safe_divide({track_listen_time}, 60000)

    - name: listen_time_per_user
      type: number
      title: 'Avg User Listen Time'
      #sql: safe_divide({listen_time_minutes}, {track_play_users})
      sql: "COALESCE({listen_time_minutes} / NULLIF({track_play_users}, 0), 0)"

    
    # #SURVEY DATA
    # - name: nps_votes
    #   type: count
    #   title: NPS Survey Votes
    #   sql: event_name
    #   filters:
    #     - sql: lower(utm_content) = 'smilies nps'
    #     - sql: event_name = 'inapp_click'

    # - name: promoters
    #   type: count
    #   title: NPS Promoters
    #   sql: event_name
    #   filters:
    #     - sql: lower(utm_content) = 'smilies nps'
    #     - sql: lower(event_label) = 'very positive'
    
    # # - name: passives
    # #   type: sum
    # #   title: NPS Neutrals
    # #   sql: case when (utm_content = 'Smilies NPS' and event_label = 'Positive') then 1 else 0 end
    
    # - name: detractors
    #   type: count
    #   title: NPS Detractors
    #   sql: event_name
    #   filters:
    #     - sql: lower(utm_content) = 'smilies nps'
    #     - sql: lower(event_label) in ('negative', 'very negative', 'neutral')
    
    # - name: nps_score_100
    #   type: number
    #   title: NPS Score (100)
    #   sql: safe_divide(({promoters} - {detractors}), {nps_votes}) * 100
    
    # - name: nps_score
    #   type: number
    #   title: NPS Score
    #   sql: ifnull(safe_divide({nps_score_100} + 100, 20), 0)

    # - name: satisfaction_votes
    #   type: count
    #   title: Satisfaction Votes
    #   sql: event_name
    #   filters:
    #     - sql: lower(utm_content) = 'satisfaction survey' 
    #     - sql: event_name = 'inapp_click'
    
    # - name: satisfaction_thumbsup
    #   type: count
    #   title: Satisfaction Thumbs Up
    #   sql: event_name
    #   filters:
    #     - sql: lower(utm_content) = 'satisfaction survey' 
    #     - sql: lower(event_label) = 'thumbs up'
    
    # - name: satisfaction_thumbsdown
    #   type: count
    #   title: Satisfaction Thumbs Down
    #   sql: event_name
    #   filters:
    #     - sql: lower(utm_content) = 'satisfaction survey'
    #     - sql: lower(event_label) = 'thumbs down'

    # - name: satisfaction_rate
    #   type: number
    #   title: Satisfaction Rate
    #   sql: ifnull(round(safe_divide({satisfaction_thumbsup}, {satisfaction_votes}), 3) * 100, 0)

    # - name: negative_feedback_votes
    #   title: Negative Votes
    #   type: count
    #   sql: event_name
    #   filters:
    #     - sql: lower(utm_content) = 'negative feedback tiles'
    #     - sql: event_name = 'inapp_click'
  
  joins:
    - name: venue_lookup_region_language
      relationship: many_to_one
      sql: "{CUBE.device_language} = {venue_lookup_region_language.device_language}"
  
  pre_aggregations:
    - name: overall_aggregation
      measures:
        - venue_dataform_overall.active_user
        - venue_dataform_overall.login_users
        - venue_dataform_overall.total_actions
        - venue_dataform_overall.object_views
        - venue_dataform_overall.object_views_users
        - venue_dataform_overall.object_scans
        - venue_dataform_overall.object_scans_users
        - venue_dataform_overall.tour_views
        - venue_dataform_overall.tour_view_users
        - venue_dataform_overall.track_plays
        - venue_dataform_overall.track_play_users
        - venue_dataform_overall.exhibition_views
        - venue_dataform_overall.exhibition_views_users
      dimensions:
        - venue_dataform_overall.datetime
        - venue_dataform_overall.venue_id
        - venue_dataform_overall.device_platform
        - venue_dataform_overall.user_connectivity
        - venue_dataform_overall.user_age_range
        - venue_dataform_overall.user_gender
        - venue_dataform_overall.country
        - venue_dataform_overall.user_type
        - venue_lookup_region_language.language_name
      timeDimension: venue_dataform_overall.datetime
      granularity: day