cubes:
  - name: venue_dataform_organisation
    data_source: default
    sql: >
      select
        event_date,
        event_params_custom.event_custom_timestamp,
        if(event_params_custom.event_custom_timestamp is null, timestamp_micros(time.event_timestamp), timestamp_seconds(event_params_custom.event_custom_timestamp)) as event_timestamp,
        user_pseudo_id,
        is_active_user,
        event_name,
        stream_id,
        device.category as device_category,
        event_params_custom.client_connectivity,
        event_params_custom.page_type,
        event_params_custom.venue_id,
        event_params_custom.location_id,
        event_params_custom.organisation_id,
        event_params_custom.zone_id,
        event_params_custom.zone_type,
        event_params_custom.object_id
      from `smartify-cc94e.superform_outputs_151371783.ga4_events`
      where event_params_custom.organisation_id = '{COMPILE_CONTEXT.securityContext.organisation_id}'
      and event_date >= DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 13 MONTH)
      and stream_id in ('1047860117','1047860114','1913717213','2817285551','10374153553')
      and event_name in ('page_view', 'screen_view', 'click_button', 'select_component')
      

    dimensions:
      - name: datetime
        type: time
        sql: event_timestamp

      - name: user_connectivity
        type: string
        sql: |-
          case
            when (client_connectivity = '' or client_connectivity is null) then 'Unknown'
            when client_connectivity in ('WIFI', 'Internet Corporate', 'Internet Highspeed') then 'Wi-Fi'
            else 'Cellular'
          end

      - name: device_platform
        type: string
        sql: |-
          case
            when stream_id = '1047860117' then 'iOS'
            when stream_id = '1047860114' then 'Android'
            when (stream_id = '1913717213' and device_category in ('tablet','desktop')) then 'Desktop'
            when (stream_id = '10374153553' or (stream_id = '1913717213' and event_custom_timestamp is not null)) then 'Hardware'
            else 'Webapp'
          end

      - name: organisation_id
        type: string
        sql: organisation_id

      - name: venue_id
        type: string
        sql: venue_id

      - name: location_id
        type: string
        sql: location_id

      - name: location_site
        type: string
        sql: REGEXP_EXTRACT(location_id, r'^([^:]+)')

      - name: zone_id
        type: string
        sql: zone_id
        primaryKey: true
        shown: true

      - name: object_id
        type: string
        sql: object_id
        primaryKey: true
        shown: true

    measures:
      - name: organisation_view
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('page_view', 'screen_view')
          - sql: page_type = 'organization_dp'

      - name: venue_view
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('page_view', 'screen_view')
          - sql: page_type = 'venue_dp'

      - name: zone_view
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('page_view', 'screen_view')
          - sql: page_type = 'venue_zone_dp'

      - name: location_page_users
        sql: event_name
        type: count_distinct_approx
        filters:
          - sql: event_name in ('page_view', 'screen_view')
          - sql: page_type in ('venue_zone_dp', 'venue_dp', 'organization_dp')

      - name: click_map_button
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('click_button', 'select_content')
          - sql: location_id in ('venue_dp:map_cta', 'zone_dp:floorplan_cta', 'venue_dp:floorplan_cta', 'zone_dp:feature_location')

      - name: venue_click_map
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('click_button')
          - sql: location_id = 'venue_dp:map_cta'

      - name: zone_click_map
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('click_button')
          - sql: location_id in ('zone_dp:map_cta', 'zone_dp:feature_location')

      # - name: map_button_ctr
      #   type: number
      #   sql: "COALESCE(CAST(({venue_click_map}+{zone_click_map}) AS FLOAT64) / NULLIF(CAST(({venue_view}+{zone_view}) AS FLOAT64), 0.0), 0.0)"
      #   "COALESCE(CAST({object_views} AS FLOAT64) / NULLIF(CAST({object_view_users} AS FLOAT64), 0.0), 0.0)"

      # - name: venue_map_ctr
      #   type: number
      #   sql: "COALESCE(CAST({venue_click_map} AS FLOAT64) / NULLIF(CAST({venue_view} AS FLOAT64), 0.0), 0.0)"
      #   "COALESCE(CAST({object_views} AS FLOAT64) / NULLIF(CAST({object_view_users} AS FLOAT64), 0.0), 0.0)"

      - name: zone_map_ctr
        type: number
        sql: "COALESCE(CAST({zone_click_map} AS FLOAT64) / NULLIF(CAST({zone_view} AS FLOAT64), 0.0), 0.0)"
      #   "COALESCE(CAST({object_views} AS FLOAT64) / NULLIF(CAST({object_view_users} AS FLOAT64), 0.0), 0.0)"
        
      - name: venue_click_secondary
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('click_button')
          - sql: location_id = 'venue_dp:secondary_button'
      
      - name: organisation_click_secondary
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('click_button')
          - sql: location_id = 'org_dp:secondary_button'

      - name: click_secondary_button
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('click_button')
          - sql: location_id in ('venue_dp:secondary_button', 'org_dp:secondary_button')

      # - name: venue_select_page_content
      #   sql: event_name
      #   type: count
      #   filters:
      #     - sql: event_name in ('select_content')
      #     - sql: location_id LIKE 'venue_dp:%'
      
      # - name: organisation_select_page_content
      #   sql: event_name
      #   type: count
      #   filters:
      #     - sql: event_name in ('select_content')
      #     - sql: location_id LIKE 'organization_dp:%'

      - name: select_page_content
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('select_content')
          - sql: location_id LIKE 'organization_dp:%' or location_id LIKE 'venue_dp:%' or location_id LIKE 'zone_dp:%' or location_id LIKE 'venue_zone_dp:%'

      # - name: venue_select_object_collection
      #   sql: event_name
      #   type: count
      #   filters:
      #     - sql: event_name in ('select_component')
      #     - sql: location_id = 'venue_collections_lp:feature_objects'

      # - name: organisation_select_object_collection
      #   sql: event_name
      #   type: count
      #   filters:
      #     - sql: event_name in ('select_component')
      #     - sql: location_id = 'organization_collections_lp:feature_objects'

      # - name: zone_select_object_collection
      #   sql: event_name
      #   type: count
      #   filters:
      #     - sql: event_name in ('select_component')
      #     - sql: location_id = 'venue_zone_dp:feature_objects'

      - name: select_object_collection
        sql: event_name
        type: count
        filters:
          - sql: event_name in ('select_component')
          - sql: location_id in ('venue_collections_lp:feature_objects', 'organization_collections_lp:feature_objects', 'venue_zone_dp:feature_objects', 'venue_zone_collection_lp:feature_objects', 'zone_dp:feature_location')

    joins:
      - name: venue_lookup_objects
        relationship: many_to_one
        sql: '{CUBE.object_id} = {venue_lookup_objects.object_sid}'
      - name: venue_lookup_zones
        relationship: many_to_one
        sql: '{CUBE.zone_id} = {venue_lookup_zones.zone_sid}'